from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler, MessageHandler, filters

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
SEASON, PLANT_TYPE = range(2)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–µ–∑–æ–Ω–∞
SEASON_KEYBOARD = [
    ["üå± –í–µ—Å–Ω–∞", "‚òÄÔ∏è –õ–µ—Ç–æ"],
    ["üçÇ –û—Å–µ–Ω—å", "‚ùÑÔ∏è –ó–∏–º–∞"]
]

# –ë–∞–∑–∞ —Å–µ–∑–æ–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
SEASONAL_RECOMMENDATIONS = {
    "–≤–µ—Å–Ω–∞": {
        "title": "üå± *–í–ï–°–ï–ù–ù–ò–ô –£–•–û–î –ó–ê –†–ê–°–¢–ï–ù–ò–Ø–ú–ò*",
        "recommendations": """
*üíß –ü–û–õ–ò–í:*
‚Ä¢ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–π—Ç–µ –ø–æ–ª–∏–≤
‚Ä¢ –ù–∞—á–∏–Ω–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–æ–¥–∫–æ—Ä–º–∫–∏
‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ–º —Ä–∞—Å—Ç–µ–Ω–∏–π

*üåø –û–°–ù–û–í–ù–´–ï –ó–ê–ë–û–¢–´:*
‚Ä¢ –ü–µ—Ä–µ—Å–∞–¥–∫–∞ –≤ –Ω–æ–≤—ã–µ –≥–æ—Ä—à–∫–∏
‚Ä¢ –û–±—Ä–µ–∑–∫–∞ –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–æ–Ω—ã
‚Ä¢ –ù–∞—á–∞–ª–æ –≤–µ–≥–µ—Ç–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –æ—Ç –≤—Ä–µ–¥–∏—Ç–µ–ª–µ–π

*‚ö†Ô∏è –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:*
‚Ä¢ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –ø—Ä–∏—É—á–µ–Ω–∏–µ –∫ —Å–≤–µ—Ç—É
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–µ—Å–µ–Ω–Ω–∏—Ö —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –∑–∞ –º–æ–ª–æ–¥—ã–º–∏ –ø–æ–±–µ–≥–∞–º–∏
"""
    },
    "–ª–µ—Ç–æ": {
        "title": "‚òÄÔ∏è *–õ–ï–¢–ù–ò–ô –£–•–û–î –ó–ê –†–ê–°–¢–ï–ù–ò–Ø–ú–ò*",
        "recommendations": """
*üíß –ü–û–õ–ò–í:*
‚Ä¢ –£–≤–µ–ª–∏—á—å—Ç–µ —á–∞—Å—Ç–æ—Ç—É –ø–æ–ª–∏–≤–∞
‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–ø—Ä—ã—Å–∫–∏–≤–∞–π—Ç–µ –ª–∏—Å—Ç—å—è
‚Ä¢ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–µ—Ä–µ—Å—ã—Ö–∞–Ω–∏–µ–º –ø–æ—á–≤—ã

*üåø –û–°–ù–û–í–ù–´–ï –ó–ê–ë–û–¢–´:*
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–ª—è—â–µ–≥–æ —Å–æ–ª–Ω—Ü–∞
‚Ä¢ –ü—Ä–æ–≤–µ—Ç—Ä–∏–≤–∞–Ω–∏–µ –ø–æ–º–µ—â–µ–Ω–∏–π
‚Ä¢ –ë–æ—Ä—å–±–∞ —Å –ø–µ—Ä–µ–≥—Ä–µ–≤–æ–º
‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–æ–¥–∫–æ—Ä–º–∫–∏

*‚ö†Ô∏è –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:*
‚Ä¢ –ü—Ä–∏—Ç–µ–Ω–µ–Ω–∏–µ –Ω–∞ —é–∂–Ω—ã—Ö –æ–∫–Ω–∞—Ö
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å –≤–ª–∞–∂–Ω–æ—Å—Ç–∏ –≤–æ–∑–¥—É—Ö–∞
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–æ–≤
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–Ω–æ—Å–∞ –Ω–∞ –±–∞–ª–∫–æ–Ω
"""
    },
    "–æ—Å–µ–Ω—å": {
        "title": "üçÇ *–û–°–ï–ù–ù–ò–ô –£–•–û–î –ó–ê –†–ê–°–¢–ï–ù–ò–Ø–ú–ò*",
        "recommendations": """
*üíß –ü–û–õ–ò–í:*
‚Ä¢ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å–æ–∫—Ä–∞—â–∞–π—Ç–µ –ø–æ–ª–∏–≤
‚Ä¢ –£–º–µ–Ω—å—à–∞–π—Ç–µ –ø–æ–¥–∫–æ—Ä–º–∫–∏
‚Ä¢ –ì–æ—Ç–æ–≤—å—Ç–µ –∫ –ø–µ—Ä–∏–æ–¥—É –ø–æ–∫–æ—è

*üåø –û–°–ù–û–í–ù–´–ï –ó–ê–ë–û–¢–´:*
‚Ä¢ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∏–º–æ–≤–∫–µ
‚Ä¢ –°–∞–Ω–∏—Ç–∞—Ä–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–µ—Ä–µ—Å–∞–¥–∫–∏
‚Ä¢ –£–±–æ—Ä–∫–∞ –æ–ø–∞–≤—à–∏—Ö –ª–∏—Å—Ç—å–µ–≤

*‚ö†Ô∏è –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:*
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤
‚Ä¢ –°–æ–∫—Ä–∞—â–µ–Ω–∏–µ —Å–≤–µ—Ç–æ–≤–æ–≥–æ –¥–Ω—è
‚Ä¢ –ü–æ–Ω–∏–∂–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã
‚Ä¢ –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –≥—Ä–∏–±–∫–æ–≤—ã—Ö –±–æ–ª–µ–∑–Ω–µ–π
"""
    },
    "–∑–∏–º–∞": {
        "title": "‚ùÑÔ∏è *–ó–ò–ú–ù–ò–ô –£–•–û–î –ó–ê –†–ê–°–¢–ï–ù–ò–Ø–ú–ò*",
        "recommendations": """
*üíß –ü–û–õ–ò–í:*
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ–ª–∏–≤
‚Ä¢ –î–∞–≤–∞–π—Ç–µ –ø–æ—á–≤–µ —Ö–æ—Ä–æ—à–æ –ø—Ä–æ—Å–æ—Ö–Ω—É—Ç—å
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–ø–ª—É—é –≤–æ–¥—É

*üåø –û–°–ù–û–í–ù–´–ï –ó–ê–ë–û–¢–´:*
‚Ä¢ –ü–µ—Ä–∏–æ–¥ –ø–æ–∫–æ—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Ä–∞—Å—Ç–µ–Ω–∏–π
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç —Ö–æ–ª–æ–¥–Ω—ã—Ö –æ–∫–æ–Ω
‚Ä¢ –ë–æ—Ä—å–±–∞ —Å —Å—É—Ö–∏–º –≤–æ–∑–¥—É—Ö–æ–º
‚Ä¢ –î–æ—Å–≤–µ—á–∏–≤–∞–Ω–∏–µ —Ñ–∏—Ç–æ–ª–∞–º–ø–∞–º–∏

*‚ö†Ô∏è –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï:*
‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞—Ç–∞—Ä–µ–π –æ—Ç–æ–ø–ª–µ–Ω–∏—è
‚Ä¢ –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —É –æ–∫–æ–Ω
‚Ä¢ –ò–∑–±–µ–≥–∞–π—Ç–µ —Ö–æ–ª–æ–¥–Ω—ã—Ö —Å–∫–≤–æ–∑–Ω—è–∫–æ–≤
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–æ–¥–∫–æ—Ä–º–∫–∏
"""
    }
}


async def start_seasonal_recommendations(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ —Å–µ–∑–æ–Ω–∞"""
    await update.message.reply_text(
        "üåø *–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≥–æ–¥–∞:*",
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup(SEASON_KEYBOARD, one_time_keyboard=True, resize_keyboard=True)
    )
    return SEASON


async def handle_season_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–µ–∑–æ–Ω–∞"""
    season_choice = update.message.text.lower()

    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤—ã–±–æ—Ä
    season_map = {
        "üå± –≤–µ—Å–Ω–∞": "–≤–µ—Å–Ω–∞",
        "‚òÄÔ∏è –ª–µ—Ç–æ": "–ª–µ—Ç–æ",
        "üçÇ –æ—Å–µ–Ω—å": "–æ—Å–µ–Ω—å",
        "‚ùÑÔ∏è –∑–∏–º–∞": "–∑–∏–º–∞"
    }

    season = season_map.get(update.message.text, season_choice)

    if season not in SEASONAL_RECOMMENDATIONS:
        await update.message.reply_text(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –≥–æ–¥–∞ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:",
            reply_markup=ReplyKeyboardMarkup(SEASON_KEYBOARD, one_time_keyboard=True, resize_keyboard=True)
        )
        return SEASON

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    context.user_data['season'] = season
    recommendations = SEASONAL_RECOMMENDATIONS[season]

    response = f"{recommendations['title']}\n\n{recommendations['recommendations']}"

    await update.message.reply_text(
        response,
        parse_mode='Markdown',
        reply_markup=ReplyKeyboardMarkup([["‚¨ÖÔ∏è –ù–∞–∑–∞–¥"]], resize_keyboard=True)
    )

    return ConversationHandler.END


async def cancel_recommendations(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞"""
    await update.message.reply_text(
        "–í–æ–∑–≤—Ä–∞—â–∞—é—Å—å –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é!",
        reply_markup=ReplyKeyboardMarkup([
            ["üå± –ú–æ–∏ —Ä–∞—Å—Ç–µ–Ω–∏—è", "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞"],
            ["üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏", "üåç –ü–æ–∏—Å–∫ —Ä–∞—Å—Ç–µ–Ω–∏–π"],
            ["üë®‚Äçüåæ –ß–∞—Ç —Å –∞–≥—Ä–æ–Ω–æ–º–æ–º"]
        ], resize_keyboard=True)
    )
    return ConversationHandler.END

# –°–æ–∑–¥–∞–µ–º ConversationHandler
def build_recommendations_conversation():
    return ConversationHandler(
        entry_points=[MessageHandler(filters.Regex("^üìö –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏$"), start_seasonal_recommendations)],
        states={
            SEASON: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_season_choice)],
        },
        fallbacks=[MessageHandler(filters.Regex("^‚¨ÖÔ∏è –ù–∞–∑–∞–¥$"), cancel_recommendations)],
        map_to_parent={
            ConversationHandler.END: ConversationHandler.END
        }
    )


# –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
async def get_recommendations(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥"""
    await start_seasonal_recommendations(update, context)